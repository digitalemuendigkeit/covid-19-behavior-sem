---
title: "COVID-19 Model Iteration 2 Endogeneity Evaluation"
output: html_document
---

```{r setup, echo =FALSE, include=FALSE}
# Include libraries
library(tidyverse)
library(seminr)
library(DT)
library(htmltools)
library(lmtest)
library(nortest)
library(car)
# Load models and create summaries
# Load PLS Model
model <- readRDS("Models/model-co-2.RDS")
bootmodel <- readRDS("Models/model-boot-co-2.RDS")
# Load bootstrapped first stage PLS model
bootfsmodel <- readRDS("Models/model-fs-boot-co-2.RDS")
# Load approximation PLS model (no HOCs, data formatted as data.frame)
proxymodel <- readRDS("Models/model-proxy-co-2.RDS")
summo <- summary(model)
sumfs <- summary(model$first_stage_model)
sumbomo <- summary(bootmodel)
sumbofsmo <- summary(bootfsmodel)
sumprmo <- summary(proxymodel)
# # Bootstrap proxy model (500 samples) for comparability
# bootprmodel <- bootstrap_model(proxymodel)
# sumboprmo <- summary(bootprmodel)
# Function for Gaussian Capula Approach
createCopula <- function(P){
	H.p <- stats::ecdf(P)
	H.p <- H.p(P)
	H.p <- ifelse(H.p==0,0.0000001,H.p)
	H.p <- ifelse(H.p==1,0.9999999,H.p)
	U.p <- H.p
	p.star <- stats::qnorm(U.p)
	return(p.star)	
}
bootstrappedSignificance <- function(dataset, bootstrapresults, numIndependentVariables, numCopulas){
	for (i in 1:nrow(summary(bootstrapresults))){
		t <- summary(bootstrapresults)[i, "original"] / summary(bootstrapresults)[i, "bootSE"]
		# df = n (number of observations) - k (number of independent variables + copulas) - 1
		pvalue <- 2 * pt(-abs(t),df=nrow(dataset)-numIndependentVariables-numCopulas-1)
		cat("Pr(>|t|)", rownames(summary(bootstrapresults))[i], ": ", pvalue, "\n")
	}
}
bootSig <- function(dataset, bootstrapresults, numIndependentVariables, numCopulas){
  bootSigvec <- vector("double", length = length(numIndependentVariables + 1))
	for (i in 1:nrow(summary(bootstrapresults))){
	  t <- summary(bootstrapresults)[i, "original"] / summary(bootstrapresults)[i, "bootSE"]
		# df = n (number of observations) - k (number of independent variables + copulas) - 1
		bootSigvec[i] <- 2 * pt(-abs(t),df=nrow(dataset)-numIndependentVariables-numCopulas-1)
	}
  return(bootSigvec)
}
```
The code for the assessment of endogeneity using the Gaussian Copula approach comes from

Hult, G. T. M., J. F. Hair, D. Proksch, M. Sarstedt, A. Pinkwart, & C. M. Ringle (2018).
Addressing Endogeneity in International Marketing Applications of Partial Least Squares Structural Equation Modeling. Journal of International Marketing, 26(3), 1â€“21. https://doi.org/10.1509/jim.17.0151


# Test of non-normality
The Gaussian Copula approach can only be used if the independent variable in question is non-normally distributed.
```{r}
# Find out if independent (i.e., exogenous) variables are non-normally distributed
# If yes, Gaussian Copula approach can be used.
#Distrusting Beliefs
shapiro.test(model$construct_scores[,"Distrusting Beliefs"])
lillie.test(model$construct_scores[,"Distrusting Beliefs"])
ggplot(as.data.frame(model$construct_scores), aes(`Distrusting Beliefs`)) +
  geom_density()
# Knowledge
shapiro.test(model$construct_scores[,"Knowledge"])
lillie.test(model$construct_scores[,"Knowledge"])
ggplot(as.data.frame(model$construct_scores), aes(`Knowledge`)) +
  geom_density()
# Response Beliefs
shapiro.test(model$construct_scores[,"Response Beliefs"])
lillie.test(model$construct_scores[,"Response Beliefs"])
ggplot(as.data.frame(model$construct_scores), aes(`Response Beliefs`)) +
  geom_density()
# Threat Beliefs
shapiro.test(model$construct_scores[,"Threat Beliefs"])
lillie.test(model$construct_scores[,"Threat Beliefs"])
ggplot(as.data.frame(model$construct_scores), aes(`Threat Beliefs`)) +
  geom_density()
# Personal Moral Norm
shapiro.test(model$construct_scores[,"Personal Moral Norm"])
lillie.test(model$construct_scores[,"Personal Moral Norm"])
ggplot(as.data.frame(model$construct_scores), aes(`Personal Moral Norm`)) +
  geom_density()
# Subjective Norm
shapiro.test(model$construct_scores[,"Subjective Norm"])
lillie.test(model$construct_scores[,"Subjective Norm"])
ggplot(as.data.frame(model$construct_scores), aes(`Subjective Norm`)) +
  geom_density()
```
All independent (or endogenous) variables are non-normally distributed.
Therefore, the Gaussian Copula approach can be used for all of them.


# Regression of Response Beliefs on Distrusting Beliefs and Knowledge
```{r gca rb}
# Define Variables for easy access
KN <- model$construct_scores[,"Knowledge"]
DI <- model$construct_scores[,"Distrusting Beliefs"]
RB <- model$construct_scores[,"Response Beliefs"]

# Define number of bootstraps: 10.000 for reporting, 100 for testing
bootrounds <- 100

# Estimate regression model
rbmodel <- lm(RB ~ DI + KN)
summary(rbmodel)
bootrb <- Boot(rbmodel, R=bootrounds)
summary(bootrb)

# Make base df
rbdf <- data.frame(Construct = c("Distrusting Beliefs", "Knowledge", "Copula Distrusting Beliefs", "Copula Knowledge"), 
                   Original.Model.Value = c(summary(bootrb)[2:3,5],NA,NA),
                   Original.Model.p = c(bootSig(model$data, bootrb, 2, 0)[2:3],NA,NA)
)

# Calculate copulas for independent variables
KN_star <- createCopula(KN)
DI_star <- createCopula(DI)


# Calculate results with copula for Distrusting Beliefs
# Input is regular model + copula + 0
copuladirb <- lm(RB ~ DI + KN + DI_star + 0)
summary(copuladirb)
# Bootstrap Standard Errors
bootcopuladirb <- Boot(copuladirb, R=bootrounds)
summary(bootcopuladirb)
# Calculate corrected p-values based on bootstrapped standard errors
# Input is data, bootstrapped results, number of independent variables, number of copulas
bootSig(model$data, bootcopuladirb, 2,1)
# Attach to df
rbdf <- rbdf %>% cbind(
  DI.Co.Model.Value = c(summary(bootcopuladirb)[1:3,5], NA),
  DI.Co.Model.p = c(bootSig(model$data, bootcopuladirb, 2,1), NA)
)

# Calculate results with copula for Knowledge
# Input is regular model + copula + 0
copulaknrb <- lm(RB ~ DI + KN + KN_star + 0)
summary(copulaknrb)
# Bootstrap Standard Errors
bootcopulaknrb <- Boot(copulaknrb, R=bootrounds)
summary(bootcopulaknrb)
# Calculate corrected p-values based on bootstrapped standard errors
# Input is data, bootstrapped results, number of independent variables, number of copulas
bootSig(model$data, bootcopulaknrb, 2,1)
# Attach to df
rbdf <- rbdf %>% cbind(
  KN.Co.Model.Value = c(summary(bootcopulaknrb)[1:2,5], NA, summary(bootcopulaknrb)[3,5]),
  KN.Co.Model.p = c(bootSig(model$data, bootcopuladirb, 2,1)[1:2], NA, bootSig(model$data, bootcopuladirb, 3,1)[3])
)

# Calculate results with copula for both DI and KN
# Input is regular model + copula + 0
copuladiknrb <- lm(RB ~ DI + KN + DI_star + KN_star + 0)
summary(copuladiknrb)
# Bootstrap Standard Errors
bootcopuladiknrb <- Boot(copuladiknrb, R=bootrounds)
summary(bootcopuladiknrb)
# Calculate corrected p-values based on bootstrapped standard errors
# Input is data, bootstrapped results, number of independent variables, number of copulas
bootstrappedSignificance(model$data, bootcopuladiknrb, 2, 2)
# Attach to df
rbdf <- rbdf %>% cbind(
  DIKN.Co.Model.Value = c(summary(bootcopuladiknrb)[1:4,5]),
  DIKN.Co.Model.p = c(bootSig(model$data, bootcopuladiknrb, 2, 2))
)
datatable(rbdf) %>%
  formatRound(-1,
              digits = 3)
```
Neither the Distrusting Beliefs nor the Knowlede Copula is significant, indicating that there is no hidden endogeneity in the regression of Response Beliefs on its predictors.

# Regression of Threat Beliefs on Distrusting Beliefs and Knowledge
```{r gca tb}
# Define Variables for easy access
TB <- model$construct_scores[,"Threat Beliefs"]

# Define number of bootstraps: 10.000 for reporting, 100 for testing
bootrounds <- 100

# Estimate regression model
tbmodel <- lm(TB ~ DI + KN)
summary(tbmodel)
boottb <- Boot(tbmodel, R=bootrounds)
summary(boottb)

# Make base df
tbdf <- data.frame(Construct = c("Distrusting Beliefs", "Knowledge", "Copula Distrusting Beliefs", "Copula Knowledge"), 
                   Original.Model.Value = c(summary(bootrb)[2:3,5],NA,NA),
                   Original.Model.p = c(bootSig(model$data, bootrb, 2, 0)[2:3],NA,NA)
)

# Calculate copulas for independent variables - already happened
# KN_star <- createCopula(KN)
# DI_star <- createCopula(DI)


# Calculate results with copula for Distrusting Beliefs
# Input is regular model + copula + 0
copuladitb <- lm(TB ~ DI + KN + DI_star + 0)
summary(copuladitb)
# Bootstrap Standard Errors
bootcopuladitb <- Boot(copuladitb, R=bootrounds)
summary(bootcopuladitb)
# Calculate corrected p-values based on bootstrapped standard errors
# Input is data, bootstrapped results, number of independent variables, number of copulas
bootSig(model$data, bootcopuladitb, 2,1)
# Attach to df
tbdf <- tbdf %>% cbind(
  DI.Co.Model.Value = c(summary(bootcopuladitb)[1:3,5], NA),
  DI.Co.Model.p = c(bootSig(model$data, bootcopuladitb, 2,1), NA)
)

# Calculate results with copula for Knowledge
# Input is regular model + copula + 0
copulakntb <- lm(TB ~ DI + KN + KN_star + 0)
summary(copulakntb)
# Bootstrap Standard Errors
bootcopulakntb <- Boot(copulakntb, R=bootrounds)
summary(bootcopulakntb)
# Calculate corrected p-values based on bootstrapped standard errors
# Input is data, bootstrapped results, number of independent variables, number of copulas
bootSig(model$data, bootcopulakntb, 2,1)
# Attach to df
tbdf <- tbdf %>% cbind(
  KN.Co.Model.Value = c(summary(bootcopulakntb)[1:2,5], NA, summary(bootcopulakntb)[3,5]),
  KN.Co.Model.p = c(bootSig(model$data, bootcopuladitb, 2,1)[1:2], NA, bootSig(model$data, bootcopuladitb, 3,1)[3])
)

# Calculate results with copula for both DI and KN
# Input is regular model + copula + 0
copuladikntb <- lm(TB ~ DI + KN + DI_star + KN_star + 0)
summary(copuladikntb)
# Bootstrap Standard Errors
bootcopuladikntb <- Boot(copuladikntb, R=bootrounds)
summary(bootcopuladikntb)
# Calculate corrected p-values based on bootstrapped standard errors
# Input is data, bootstrapped results, number of independent variables, number of copulas
bootstrappedSignificance(model$data, bootcopuladikntb, 2, 2)
# Attach to df
tbdf <- tbdf %>% cbind(
  DIKN.Co.Model.Value = c(summary(bootcopuladikntb)[1:4,5]),
  DIKN.Co.Model.p = c(bootSig(model$data, bootcopuladikntb, 2, 2))
)
datatable(tbdf) %>%
  formatRound(-1,
              digits = 3)
```
Neither the Distrusting Beliefs nor the Knowledge Copula is significant, indicating that there is no hidden endogeneity in the regression of Threat Beliefs on its predictors.

# Regression of Behavioral Intention on its predictors
```{r gca bi}
# Define Variables for easy access
BI <- model$construct_scores[,"Behavioral Intention"]
PN <- model$construct_scores[,"Personal Moral Norm"]
SN <- model$construct_scores[,"Subjective Norm"]

# Define number of bootstraps: 10.000 for reporting, 100 for testing
bootrounds <- 100

# Estimate regression model
bimodel <- lm(BI ~ RB + TB + PN + SN)
summary(bimodel)
bootbi <- Boot(bimodel, R=bootrounds)
summary(bootbi)

# Make base df
bidf <- data.frame(Construct = c("Response Beliefs", "Threat Beliefs", "Personal Moral Norm", "Subjective Norm", "Copula Response Beliefs", "Copula Threat Beliefs", "Copula Personal Moral Norm", "Copula Subjective Norm"), 
                   Original.Model.Value = c(summary(bootbi)[2:5,5],NA,NA,NA,NA),
                   Original.Model.p = c(bootSig(model$data, bootbi, 4, 0)[2:5],NA,NA,NA,NA)
)

# Calculate copulas for independent variables - already happened
RB_star <- createCopula(RB)
TB_star <- createCopula(TB)
PN_star <- createCopula(PN)
SN_star <- createCopula(SN)

# Calculate results with copula for Response Beliefs
# Input is regular model + copula + 0
copularbbi <- lm(BI ~ RB + TB + PN + SN + RB_star + 0)
summary(copularbbi)
# Bootstrap Standard Errors
bootcopularbbi <- Boot(copularbbi)
summary(bootcopularbbi)
# Calculate corrected p-values based on bootstrapped standard errors
# Input is data, bootstrapped results, number of independent variables, number of copulas
bootSig(model$data, bootcopularbbi, 4,1)
# Attach to df
bidf <- bidf %>% cbind(
  RB.Co.Model.Value = c(summary(bootcopularbbi)[,5], NA, NA, NA),
  RB.Co.Model.p = c(bootSig(model$data, bootcopularbbi, 4,1), NA, NA, NA)
)

# Calculate results with copula for Threat Beliefs
# Input is regular model + copula + 0
copulatbbi <- lm(BI ~ RB + TB + PN + SN + TB_star + 0)
summary(copulatbbi)
# Bootstrap Standard Errors
bootcopulatbbi <- Boot(copulatbbi)
summary(bootcopulatbbi)
# Calculate corrected p-values based on bootstrapped standard errors
# Input is data, bootstrapped results, number of independent variables, number of copulas
bootSig(model$data, bootcopulatbbi, 4,1)
# Attach to df
bidf <- bidf %>% cbind(
  TB.Co.Model.Value = c(summary(bootcopulatbbi)[1:4,5], NA, summary(bootcopulatbbi)[5,5],  NA, NA),
  TB.Co.Model.p = c(bootSig(model$data, bootcopulatbbi, 4,1)[1:4], NA, bootSig(model$data, bootcopulatbbi, 4,1)[5], NA, NA)
)

# Calculate results with copula for Personal Moral Norm
# Input is regular model + copula + 0
copulapnbi <- lm(BI ~ RB + TB + PN + SN + PN_star + 0)
summary(copulapnbi)
# Bootstrap Standard Errors
bootcopulapnbi <- Boot(copulapnbi)
summary(bootcopulapnbi)
# Calculate corrected p-values based on bootstrapped standard errors
# Input is data, bootstrapped results, number of independent variables, number of copulas
bootSig(model$data, bootcopulapnbi, 4,1)
# Attach to df
bidf <- bidf %>% cbind(
  PN.Co.Model.Value = c(summary(bootcopulapnbi)[1:4,5], NA, NA, summary(bootcopulapnbi)[5,5],  NA),
  PN.Co.Model.p = c(bootSig(model$data, bootcopulapnbi, 4,1)[1:4], NA,  NA, bootSig(model$data, bootcopulapnbi, 4,1)[5],NA)
)

# Calculate results with copula for Subjective Norm
# Input is regular model + copula + 0
copulasnbi <- lm(BI ~ RB + TB + PN + SN + SN_star + 0)
summary(copulasnbi)
# Bootstrap Standard Errors
bootcopulasnbi <- Boot(copulasnbi)
summary(bootcopulasnbi)
# Calculate corrected p-values based on bootstrapped standard errors
# Input is data, bootstrapped results, number of independent variables, number of copulas
bootSig(model$data, bootcopulasnbi, 4,1)
# Attach to df
bidf <- bidf %>% cbind(
  SN.Co.Model.Value = c(summary(bootcopulasnbi)[1:4,5], NA, NA, NA, summary(bootcopulasnbi)[5,5]),
  SN.Co.Model.p = c(bootSig(model$data, bootcopulasnbi, 4,1)[1:4], NA,  NA, NA, bootSig(model$data, bootcopulasnbi, 4,1)[5])
)

```
In looking only at single copulas, indicating that there is no hidden endogeneity in the regression of Threat Beliefs on its predictors.
