---
title: "Climate Crisis Model 3b Structural Model Evaluation"
output: html_document
---

```{r setup, echo =FALSE, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Include libraries
library(tidyverse)
library(seminr)
library(DT)
library(htmltools)
# library(remotes)
# remotes::install_github("sem-in-r/pls-predict", ref = "master", force = TRUE)
# library(PLSpredict)
# Load models and create summaries
model <- readRDS("Models/model-cc-3b.RDS")
bootmodel <- readRDS("Models/model-boot-cc-3b.RDS")
summo <- summary(model)
sumfs <- summary(model$first_stage_model)
sumbomo <- summary(bootmodel)
# Set seminr plot theme
thm <- seminr_theme_create(construct.compositeA.arrow = "backward", construct.compositeA.use_weights = FALSE, plot.adj = FALSE)
seminr_theme_set(thm)
# My favorite operator
`%notin%` <- Negate(`%in%`)
```

# Model plots
## Structural Model Only
This is a path model showing only the structural model components.
```{r plot mm model, echo=FALSE}
plot(bootmodel, structure_only = TRUE)
```

# Collinearity
Collinearity is assessed using the variance inflation factor (VIF). VIF should be < 5, ideally $\leq$ 3.
```{r collinearity vif, echo = FALSE}
vif <- data.frame('Exogenous Construct' = character(),
                  'Endogenous Construct' = character(),
                      VIF = double ())
for (i in 1:length(summo$vif_antecedents)){
  x = names(summo$vif_antecedents[i])
  for (j in 1:length(summo$vif_antecedents[[{{x}}]])){
    y = names(summo$vif_antecedents[[{{x}}]])[j]
    vif <- vif %>% rbind(data.frame('Exogenous Construct' = {{y}},
                                    'Endogenous Construct' = {{x}},
                                    VIF = summo$vif_antecedents[[{{x}}]][j]))
  }
}
locvif <- data.frame('Exogenous Construct' = character(),
                  'Endogenous Construct' = character(),
                      VIF = double ())
for (i in 1:length(sumfs$vif_antecedents)){
  x = names(sumfs$vif_antecedents[i])
  for (j in 1:length(sumfs$vif_antecedents[[{{x}}]])){
    y = names(sumfs$vif_antecedents[[{{x}}]])[j]
    locvif <- locvif %>% rbind(data.frame('Exogenous Construct' = {{y}},
                                    'Endogenous Construct' = {{x}},
                                    VIF = sumfs$vif_antecedents[[{{x}}]][j]))
  }
}
locvif <- locvif %>% filter(!(Exogenous.Construct %in% vif$Exogenous.Construct & Endogenous.Construct %in% vif$Endogenous.Construct))
vif <- union(vif, locvif)
datatable(vif,
          filter = 'top',
          options = list(pageLength = nrow(vif)),
          rownames = FALSE,
          colnames = c('Exogenous Construct' = 1,
                        'Endogenous Construct' = 2),
          caption = 'Results of the structural collinearity assessment') %>%
  formatRound(3,
              digits = 3) %>%
  formatStyle('VIF', backgroundColor = styleInterval(cuts = c(3,5), values = c('#00', '#ffe5e5','#ff9999')))
```
None of the VIF values is above 5, though there are suggestions of overlap (VIF > 3) for the Distrusting Beliefs and Response Beliefs lower-order constructs, as well as for the Distrusting Beliefs and Threat Beliefs Constructs. As these constructs are conceptually very different, this points to the intercorrelation between the different HOC subconstructs rivaling the intracorrelation between the respective HOC subconstructs (does it?). However, on the HOC level, there are no VIF issues, therefore they can be retained. The VIF for Personal Moral Norm and Behavioral Intention is also above 3, but only slightly so. 

# In-sample predictive power
In-sample predictive power is assessed using variance explained R². R² $\geq$ 0.75 indicates substantial in-sample predictive power, R² $\geq$ 0.5 moderate and R² $\geq$ 0.25 weak in-sample predictive power. R² $\leq$ 0.10 indicates a lack of model predictiveness.
```{r in-sample pp r^2, echo=FALSE}
r2hoc <- data.frame(Construct = colnames(summo$paths),
                    "R^2" = summo$paths[1,],
                    "AdjR^2" = summo$paths[2,])
r2loc <- data.frame(Construct = colnames(sumfs$paths),
                    "R^2" = sumfs$paths[1,],
                    "AdjR^2" = sumfs$paths[2,]) %>%
  filter(Construct %notin% r2hoc$Construct)
r2 <- union(r2hoc, r2loc)
datatable(r2,
          filter = 'top',
          options = list(pageLength = nrow(r2)),
          rownames = FALSE,
          colnames = c('R²' = 2,
                        'R²adj' = 3),
          caption = 'In-sample predictive power') %>%
  formatRound(2:3,
              digits = 3) %>%
  formatStyle('R²', backgroundColor = styleInterval(cuts = c(0.1,0.25,0.9), values = c('#ff9999', '#ffe5e5', '#00','#ff9999')))
```
The R² for Perceived Response Costs and Perceived Self-Efficacy are below the threshold, while the R² for Response Beliefs and Perceived Response Efficacy are very weak. Possibly, splitting this higher-order construct into distinct constructs could lead to a more differentiated model.


# Effect size
Effect size f2² measures the impact of a predictor construct on an endogenous construct. f² $\geq$ 0.35 indicates a large effect, f² $\geq$ 0.15 a medium and f² $\geq$ 0.02 a small effect.

```{r effect size f^2, echo=FALSE}
smhoc <- data.frame(model$smMatrix) %>% 
  rename('Exogenous Construct' = source,
         'Endogenous Construct' = target)
hocf2vec <- c()
for (i in 1:nrow(smhoc)){
  x = smhoc[i,1]
  y = smhoc[i, 2]
hocf2vec <- append(hocf2vec, summo$fSquare[[{{x}},{{y}}]])  
}
hocf2 <- smhoc %>% cbind(hocf2vec) %>% rename('f^2' = 3)
smloc <- data.frame(model$first_stage_model$smMatrix) %>% 
  rename('Exogenous Construct' = source,
         'Endogenous Construct' = target) %>%
  filter('Exogenous Construct' %notin% smhoc$`Exogenous Construct`)
locf2vec <- c()
for (i in 1:nrow(smloc)){
  x = smloc[i,1]
  y = smloc[i, 2]
locf2vec <- append(locf2vec, sumfs$fSquare[[{{x}},{{y}}]])  
}
locf2 <- smloc %>% cbind(locf2vec) %>% rename('f^2' = 3) %>% 
  filter(!(`Exogenous Construct` %in% hocf2$`Exogenous Construct` & `Endogenous Construct` %in% hocf2$`Endogenous Construct`))
f2 <- union(hocf2, locf2)
datatable(f2,
          filter = 'top',
          options = list(pageLength = nrow(f2)),
          rownames = FALSE,
          colnames = c('f²' = 3),
          caption = 'Effect sizes') %>%
  formatRound(3,
              digits = 3) %>%
  formatStyle('f²', backgroundColor = styleInterval(cuts = c(0.02), values = c('#ff9999', '#00')))
```
With a lower threshold of 0.02, the effect sizes of many lower-order constructs are negligible. Concerning higher-order constructs or regular constructs, there is no discernible effect of Subjective Norm and Personal Moral Norm on Behavioral Intention, and no effect of Knowledge on Response Beliefs. The effect of Threat Beliefs on Behavioral Intention is very weak (f² = 0.015), but the path might be retained if the path coefficient is significant.

# Out-of-sample predictive power
Out of sample predictive power cannot be valuated using R, simplePLS seems to be deprecated.

# Significance and relevance of path coefficients
Significance is denoted by t-test and p values. A t of $\geq$ 1.65 signifies significance at the 10 % level, t $\geq$ 1.96 at the 5 % level and t $\geq$ 2.57 at the 1 % level.
```{r path-coeff, echo = FALSE}
pcbase <- rownames_to_column(as.data.frame(sumbomo$bootstrapped_paths)) %>% rename (
  Construct.Rel. = rowname)
pcbasesplit <- base::strsplit(pcbase$Construct.Rel., "  ->  ")
pcbasesplit1 <- c()
pcbasesplit2 <- c()
for (i in 1:length(pcbasesplit)){
  pcbasesplit1 <- append(pcbasesplit1, pcbasesplit[[i]][1])
  pcbasesplit2 <- append(pcbasesplit2, pcbasesplit[[i]][2])
}
pcdf <- (pcbase %>% 
  mutate('Exogenous Construct' = pcbasesplit1, 
         'Endogenous Construct' = pcbasesplit2,
         Construct.Rel. = NULL,
         t = abs(pcbase$`T Stat.`),
         p = pt(abs(pcbase$`T Stat.`), nrow(model$data), lower.tail = FALSE),
         '0 in CI' = ifelse(pcbase$`2.5% CI` < 0 &  pcbase$`97.5% CI` > 0, TRUE, FALSE),)
  )[,c(7:8,1:3,5:6,11,9:10)]
colnames(pcdf)[9] <- paste0("t(", nrow(model$data), ")")
datatable(pcdf,
          filter = 'top',
          options = list(pageLength = nrow(pcdf)),
          rownames = FALSE,
          colnames = c("Original Estimate" = 3),
          caption = 'Relevance and significance of path coefficients') %>%
  formatRound(c(3:7, 9:10),
              digits = 3) %>%
  formatStyle(colnames(pcdf)[9], backgroundColor = styleInterval(cuts = c(1.65), values = c('#ff9999', '#00'))) %>%
  formatStyle('p', backgroundColor = styleInterval(cuts = c(0.05), values = c( '#00', '#ff9999'))) %>%
  formatStyle('0 in CI', backgroundColor = styleEqual(c(1,0), c('#ff9999', '#00'), default = NULL))
```
As indicated by the t-values or a change of sign in the CI, there is a lack of significance for the path from Knowledge to Response Beliefs as well as for the paths from Personal Moral Norm and Subjective Norm to Behavioral Intention. The coefficient for the path from Threat Beliefs to Behavioral Intention is small, but significant.

# Summary table
```{r summary table-df, echo = FALSE, include = FALSE}
sumsm <- pcdf[,-c(3,5:7)] %>% 
  left_join(hocf2)  %>%
  left_join(vif %>% rename('Exogenous Construct' = 'Exogenous.Construct',
                           'Endogenous Construct' = 'Endogenous.Construct')) %>%
  rename('Path Coefficient Bootstrap Mean' = 'Bootstrap Mean',
         '0 in Path Coefficient CI' = '0 in CI',
         'Path Coefficient p' = 'p')
colnames(sumsm)[5] <- paste0("Path Coefficient t(", nrow(model$data), ")")
```
```{r summary table-df print, echo = FALSE}
datatable(sumsm,
          filter = 'top',
          options = list(pageLength = nrow(sumsm)),
          rownames = FALSE,
          colnames = c("f²" = 7),
          caption = 'Structural Model Summary') %>%
  formatRound(c(3,5:8),
              digits = 3) %>%
  formatStyle(colnames(sumsm)[5], backgroundColor = styleInterval(cuts = c(1.65), values = c('#ff9999', '#00'))) %>%
  formatStyle('Path Coefficient p', backgroundColor = styleInterval(cuts = c(0.05), values = c( '#00', '#ff9999'))) %>%
  formatStyle('0 in Path Coefficient CI', backgroundColor = styleEqual(c(1,0), c('#ff9999', '#00'), default = NULL)) %>%
  formatStyle('f²', backgroundColor = styleInterval(cuts = c(0.02), values = c('#ff9999', '#00'))) %>%
  formatStyle('VIF', backgroundColor = styleInterval(cuts = c(3,5), values = c('#00', '#ffe5e5','#ff9999')))
```

# Results summary
As indicated by the summary table, the paths from Knowledge to Response Beliefs as well as the paths from Personal Moral Norm and Subjective Norm to Behavioral Intention are insignificant and can be omitted. Further, it would be interesting to see what happens if the Response Beliefs construct is split.
