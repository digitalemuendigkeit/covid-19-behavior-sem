---
title: "Climate Crisis Model Iteration 2-a-3 Measurement Model Evaluation"
output: html_document
---

```{r setup, echo =FALSE, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Include libraries
library(tidyverse)
library(seminr)
library(DT)
library(htmltools)
# Load models and create summaries
model <- readRDS("Models/model-cc-2-a-3.RDS")
bootmodel <- readRDS("Models/model-boot-cc-2-a-3.RDS")
summo <- summary(model)
sumbomo <- summary(bootmodel)
# Set seminr plot theme
thm <- seminr_theme_create(construct.compositeA.arrow = "backward", construct.compositeA.use_weights = FALSE, plot.adj = FALSE)
seminr_theme_set(thm)
```

# Model plots
## Original Estimate Path Model
This is the original estimate path model.
```{r plot model, echo=FALSE}
plot(model, title = "Original Estimate Model")
```

## Bootstrapped Path Model
This is the bootstrapped path model.
```{r plot bootmodel, echo=FALSE}
plot(bootmodel, title = "Bootstrapped Model")
```

## Measurement Model Only
This is a path model showing only the measurement model components.
```{r plot mm model, echo=FALSE}
plot(bootmodel, measurement_only = TRUE)
```
```{r eval-df, echo = FALSE, include=FALSE}
# Base DF
evalmm <- data.frame(Construct = model$mmMatrix[,1],
                           Type = ifelse(grepl("HOCB", model$mmMatrix[,3]),
                                         "HOC", "Construct"),
                           Mode = dplyr::recode(model$mmMatrix[,3],
                                         "A" = "reflective",
                                         "B" = "formative",
                                         "HOCB" = "higher-order"),
                           Indicator.or.LOC = model$mmMatrix[,2])
```

# Evaluation of the reflective measurement model
```{r ref-eval prep, echo = FALSE, include=FALSE}
refevalmmbase <- evalmm %>% filter(Mode == "reflective") %>% rename(Indicator = Indicator.or.LOC) %>% 
  mutate(Type = NULL, Mode = NULL)
refloadings <- c()
for (i in 1:nrow(refevalmmbase)){
  refloadings <<- append(refloadings, summo$loadings[refevalmmbase$Indicator[i], refevalmmbase$Construct[i]])
}

cicr <- data.frame(Construct = row.names(summo$reliability), 
                   AVE = as.numeric(summo$reliability[,3]), 
                   Calpha = as.numeric(summo$reliability[,1]),
                   rhoC = as.numeric(summo$reliability[,2]),
                   rhoA = as.numeric(summo$reliability[,4]))
#Next step is HTMT
boothtmtbase <- data.frame(Construct.Rel. = row.names(sumbomo$bootstrapped_HTMT),
                          Lower.CI = as.numeric(sumbomo$bootstrapped_HTMT[,5]),
                          Upper.CI = as.numeric(sumbomo$bootstrapped_HTMT[,6])) %>%
  rbind(data.frame(Construct.Rel. = row.names(sumbofsmo$bootstrapped_HTMT),
                          Lower.CI = as.numeric(sumbofsmo$bootstrapped_HTMT[,5]),
                          Upper.CI = as.numeric(sumbofsmo$bootstrapped_HTMT[,6])))
#For HTMT evaluation, one should consider only reflective constructs and LOCs
htmtvec <- c(unique(refevalmmbase$Construct))
# Transform "Relationships" Column into two distinct columns
boothtmtsplit <- base::strsplit(boothtmtbase$Construct.Rel., "  ->  ")
boothtmtsplit1 <- c()
boothtmtsplit2 <- c()
for (i in 1:length(boothtmtsplit)){
 boothtmtsplit1 <<- append(boothtmtsplit1, boothtmtsplit[[i]][1])
 boothtmtsplit2 <<- append(boothtmtsplit2, boothtmtsplit[[i]][2])
}
boothtmt <- (boothtmtbase %>% mutate(Construct.Rel. = NULL, Construct.1 = boothtmtsplit1, Construct.2 = boothtmtsplit2))[,c(3:4,1:2)] %>%
  filter(Construct.1 %in% htmtvec & Construct.2 %in% htmtvec)
maxhtmt <- data.frame(Construct = boothtmt[,1], Max.HTMT =  boothtmt[,4]) %>% 
  rbind(data.frame(Construct = boothtmt[,2], Max.HTMT =  boothtmt[,4])) %>%
  group_by(Construct) %>%
  summarise(Max.HTMT = max(Max.HTMT)) %>%
  mutate('1.in.HTMT.CI' = ifelse(Max.HTMT >=1, TRUE, FALSE))
# Make final data frame
refevalmm <- refevalmmbase %>% cbind(Loadings = refloadings) %>% left_join(cicr) %>% left_join(maxhtmt[,c(1,3)])
```

## Convergent validity
Ideally, outer loadings (<font face="Symbol">l</font>) should be $\geq$ 0.70. Loadings below 0.40 are unacceptable. AVE should be > 0.50. 

## Internal consistency reliability
Both Cronbach's <font face="Symbol">a</font> and composite reliability <font face="Symbol">r</font><sub>c</sub> should be $\geq$ 0.60 and $\leq$ 0.90. The upper threshold of acceptability is 0.95.

## Discriminant validity
Discriminant validity is evaluated using the heterotrait-monotrait ratio (HTMT). The HTMT bootstrap confidence interval should not contain 1.

```{r ref-eval, echo=FALSE}
datatable(refevalmm,
          filter = 'top',
          options = list(pageLength = nrow(refevalmm)),
          rownames = FALSE,
          colnames = c("Loading" = 3,
                        "Cronbach\'s alpha" = 5, 
                       "Composite reliability" = 6,
                       "Construct reliability" = 7,
                       "1 in HTMT CI" = 8),
          caption = 'Results of the reflective measurement model evaluation') %>%
  formatRound(3:7,
              digits = 3) %>%
  formatStyle('Loading', backgroundColor = styleInterval(cuts = c(0.4, 0.708), values = c('#ff9999', '#ffe5e5', '#00'))) %>%
  formatStyle('AVE', backgroundColor = styleInterval(cuts = c(0.5), values = c('#ff9999', '#00'))) %>%
  formatStyle('Cronbach\'s alpha', backgroundColor = styleInterval(cuts = c(0.6,0.9,0.95,0.999), values = c('#ff9999', '#00','#ffe5e5',  '#ff9999', '#00'))) %>%
  formatStyle('Composite reliability', backgroundColor = styleInterval(cuts = c(0.6,0.9,0.95,0.999), values = c('#ff9999', '#00', '#ffe5e5', '#ff9999', '#00'))) %>%
    formatStyle('Construct reliability', backgroundColor = styleInterval(cuts = c(0.6,0.9,0.95,0.999), values = c('#ff9999', '#00','#ffe5e5',  '#ff9999', '#00'))) %>%
  formatStyle('1 in HTMT CI', backgroundColor = styleEqual(c(1,0), c('#ff9999', '#00'), default = NULL))
```
Covnergent validity and internal consistency reliability is established for all constructs, but, as expected, there are issues with the HTMT CI for the Distrusting Beliefs constructs.

```{r ref-eval-HTMT,echo=FALSE}
#If there are problems with the HTMT, here is a detailed table
datatable(boothtmt,
          filter = 'top',
          options = list(pageLength = nrow(boothtmt)),
          rownames = FALSE,
          colnames = c("Construct 1" = 1,
                        "Construct 2" = 2, 
                       "Lower CI HTMT" = 3, 
                       "Upper CI HTMT" = 4),
          caption = 'Details of the bootstrapped HTMT ratios') %>%
  formatRound(3:4,
              digits = 3) %>%
    formatStyle('Lower CI HTMT', backgroundColor = styleInterval(cuts = c(0.9,1), values = c('#00', '#ffe5e5', '#ff9999'))) %>%
  formatStyle('Upper CI HTMT', backgroundColor = styleInterval(cuts = c(0.9,1), values = c('#00', '#ffe5e5', '#ff9999')))
```
There is overlap between all three Distrusting Beliefs constructs.
One possible remedy is to delete indicators with high crossloadings and/or low intercorrelation.

```{r htmt relief, echo = FALSE, include = FALSE}
cor(model$data %>% select(starts_with("CCDI")))
as.data.frame(summo$val$cross_loadings) %>% rownames_to_column  %>% filter(str_detect(rowname, "CCDI")) %>% select(starts_with("Distrusting") | starts_with("rowname"))
```
For Benevolence, CCDI2 has the lowest intercorrelation.
For Competence, CCDI4 has the lowest intercorrelation.
For Integrity, CCDI9 has the lowest intercorrelation.
Setting a threshold of 0.7, CCDI1 cross-loads on Integrity.
CCDI2 cross-loads on Competence, though slightly less.
CCDI3 does not cross-load.
CCDI4 and CCDI5 cross-load on Integrity.
CCDI6 cross-loads both on Integrity and, to a lesser degree, Benevolence.
CCDI7, CCDI8, and CCDI9 all cross-load on Competence.

## Results of the evaluation of the reflective measurement model
There is substantial overlap between the Distrusting Beliefs constructs.
This overlap is unlikely to be remedied with indicator deletion.

# Results summary
There are neither formative constructs nor higher-order constructs.
Because of substantial HTMT problems, this model has to be discarded.
