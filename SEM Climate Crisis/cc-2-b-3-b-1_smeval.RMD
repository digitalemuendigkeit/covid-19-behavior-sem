---
title: "Climate Crisis Model Iteration 2-b-3-b-1 (Only Heating) Structural Model Evaluation"
output: html_document
---

```{r setup, echo =FALSE, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Include libraries
library(tidyverse)
library(seminr)
library(DT)
library(htmltools)
# library(remotes)
# remotes::install_github("sem-in-r/pls-predict", ref = "master", force = TRUE)
# library(PLSpredict)
# Load models and create summaries
model <- readRDS("Models/model-cc-2-b-3-b-1.RDS")
bootmodel <- readRDS("Models/model-boot-cc-2-b-3-b-1.RDS")
proxymodel <- readRDS("Models/model-proxy-cc-2-b-3-b-1.RDS")
summo <- summary(model)
sumbomo <- summary(bootmodel)
# Set seminr plot theme
thm <- seminr_theme_create(construct.compositeA.arrow = "backward", construct.compositeA.use_weights = FALSE, plot.adj = FALSE)
seminr_theme_set(thm)
# My favorite operator
`%notin%` <- Negate(`%in%`)
```

# Model plots
## Structural Model Only
This is a path model showing only the structural model components.
```{r plot mm model, echo=FALSE}
plot(bootmodel, structure_only = TRUE)
```

# Collinearity
Collinearity is assessed using the variance inflation factor (VIF). VIF should be < 5, ideally $\leq$ 3.
```{r collinearity vif, echo = FALSE}
vif <- data.frame('Exogenous Construct' = character(),
                  'Endogenous Construct' = character(),
                      VIF = double ())
for (i in 1:length(summo$vif_antecedents)){
  x = names(summo$vif_antecedents[i])
  for (j in 1:length(summo$vif_antecedents[[{{x}}]])){
    y = names(summo$vif_antecedents[[{{x}}]])[j]
    vif <- vif %>% rbind(data.frame('Exogenous Construct' = {{y}},
                                    'Endogenous Construct' = {{x}},
                                    VIF = summo$vif_antecedents[[{{x}}]][j]))
  }
}
datatable(vif,
          filter = 'top',
          options = list(pageLength = nrow(vif)),
          rownames = FALSE,
          colnames = c('Exogenous Construct' = 1,
                        'Endogenous Construct' = 2),
          caption = 'Results of the structural collinearity assessment') %>%
  formatRound(3,
              digits = 3) %>%
  formatStyle('VIF', backgroundColor = styleInterval(cuts = c(3,5), values = c('#00', '#ffe5e5','#ff9999')))
```
There is no structural collinearity as assessed by VIF.


# In-sample predictive power
In-sample predictive power is assessed using variance explained R². R² $\geq$ 0.75 indicates substantial in-sample predictive power, R² $\geq$ 0.5 moderate and R² $\geq$ 0.25 weak in-sample predictive power. R² $\leq$ 0.10 indicates a lack of model predictiveness.
```{r in-sample pp r^2, echo=FALSE}
r2 <- data.frame(Construct = colnames(summo$paths),
                    "R^2" = summo$paths[1,],
                    "AdjR^2" = summo$paths[2,])
datatable(r2,
          filter = 'top',
          options = list(pageLength = nrow(r2)),
          rownames = FALSE,
          colnames = c('R²' = 2,
                        'R²adj' = 3),
          caption = 'In-sample predictive power') %>%
  formatRound(2:3,
              digits = 3) %>%
  formatStyle('R²', backgroundColor = styleInterval(cuts = c(0.1,0.249,0.9), values = c('#ff9999', '#ffe5e5', '#00','#ff9999')))
```
R² for Perceived Response Costs is below the critical threshold.
For Perceived Self-Efficacy and Perceived Response Efficacy the model predictiveness is very weak.
For Behavioral Intention, the model predictiveness is weak.

# Effect size
Effect size f2² measures the impact of a predictor construct on an endogenous construct. f² $\geq$ 0.35 indicates a large effect, f² $\geq$ 0.15 a medium and f² $\geq$ 0.02 a small effect.

```{r effect size f^2, echo=FALSE}
smloc <- data.frame(model$smMatrix) %>% 
  rename('Exogenous Construct' = source,
         'Endogenous Construct' = target)
locf2vec <- c()
for (i in 1:nrow(smloc)){
  x = smloc[i,1]
  y = smloc[i, 2]
locf2vec <- append(locf2vec, summo$fSquare[[{{x}},{{y}}]])  
}
f2 <- smloc %>% cbind(locf2vec) %>% rename('f^2' = 3)
datatable(f2,
          filter = 'top',
          options = list(pageLength = nrow(f2)),
          rownames = FALSE,
          colnames = c('f²' = 3),
          caption = 'Effect sizes') %>%
  formatRound(3,
              digits = 3) %>%
  formatStyle('f²', backgroundColor = styleInterval(cuts = c(0.019), values = c('#ff9999', '#00')))
```
Knowledge has no discernible effect on any construct.
Neither do Perceived Response Costs and Perceived Response Efficacy on Behavioral Intention.

# Out-of-sample predictive power
Out of sample predictive power has to be evaluated using a simplified model without HOCs as an approximation as seminr as of now does not support plspredict for HOC
If the root mean square error (RMSE) or the mean absolute deviation (MAD) of the naive LM model is below the ones for the PLS model, this indicates a lack of predictive power.
```{r plspredict, echo = FALSE}
plspre <- predict_pls(proxymodel, noFolds = 10)
sumplspre <- summary(plspre)
oospp <- (as.data.frame(sumplspre$PLS_out_of_sample) %>%
  rbind(as.data.frame(sumplspre$LM_out_of_sample)) %>%
  rbind((as.data.frame(sumplspre$LM_out_of_sample))[1,] - (as.data.frame(sumplspre$PLS_out_of_sample))[1,]) %>%
  rbind((as.data.frame(sumplspre$LM_out_of_sample))[2,] - (as.data.frame(sumplspre$PLS_out_of_sample))[2,])  %>%
  cbind(`Prediction Errors` = c("PLS RMSE", "PLS MAD", "LM RMSE", "LM MAD", "RMSE Difference", "MAD Difference")))[c(1,3,5,2,4,6),c(ncol(sumplspre$PLS_out_of_sample)+1,1:ncol(sumplspre$PLS_out_of_sample))]
datatable(oospp,
          options = list(pageLength = nrow(oospp)),
          rownames = FALSE,
          caption = 'Out-of-sample predictive power') %>%
  formatRound(-1,
              digits = 3) %>%
  formatStyle(names(oospp), backgroundColor = styleInterval(cuts = c(0), values = c('#ff9999', '#00')))
```

For the approximation model, the PLS model predicts only CCIBI2 better than the naive linear model.
Overall, the model has low out-of-sample predictive power.

# Significance and relevance of path coefficients
Significance is denoted by t-test and p values. A t of $\geq$ 1.65 signifies significance at the 10 % level, t $\geq$ 1.96 at the 5 % level and t $\geq$ 2.57 at the 1 % level.
```{r path-coeff, echo = FALSE}
pcbase <- rownames_to_column(as.data.frame(sumbomo$bootstrapped_paths)) %>% rename (
  Construct.Rel. = rowname)
pcbasesplit <- base::strsplit(pcbase$Construct.Rel., "  ->  ")
pcbasesplit1 <- c()
pcbasesplit2 <- c()
for (i in 1:length(pcbasesplit)){
  pcbasesplit1 <- append(pcbasesplit1, pcbasesplit[[i]][1])
  pcbasesplit2 <- append(pcbasesplit2, pcbasesplit[[i]][2])
}
pcalldf <- (pcbase %>% 
  mutate('Exogenous Construct' = pcbasesplit1, 
         'Endogenous Construct' = pcbasesplit2,
         Construct.Rel. = NULL,
         t = abs(pcbase$`T Stat.`),
         p = pt(abs(pcbase$`T Stat.`), nrow(model$data), lower.tail = FALSE),
         '0 in CI' = ifelse(pcbase$`2.5% CI` < 0 &  pcbase$`97.5% CI` > 0, TRUE, FALSE),)
  )[,c(7:8,1:3,5:6,11,9:10)]
colnames(pcalldf)[9] <- paste0("t(", nrow(model$data), ")")
datatable(pcalldf,
          filter = 'top',
          options = list(pageLength = nrow(pcalldf)),
          rownames = FALSE,
          colnames = c("Original Estimate" = 3),
          caption = 'Relevance and significance of path coefficients') %>%
  formatRound(c(3:7, 9:10),
              digits = 3) %>%
  formatStyle(colnames(pcalldf)[9], backgroundColor = styleInterval(cuts = c(1.65), values = c('#ff9999', '#00'))) %>%
  formatStyle('p', backgroundColor = styleInterval(cuts = c(0.05), values = c( '#00', '#ff9999'))) %>%
  formatStyle('0 in CI', backgroundColor = styleEqual(c(1,0), c('#ff9999', '#00'), default = NULL))
```
The path coefficients from Knowledge to Perceived Response Efficacy and Perceived Response Costs are insignificant.
So is the coefficient for the path from Perceived Response Costs to Behavioral Intention.

# Summary table
```{r summary table-df, echo = FALSE, include = FALSE}
sumsm <- pcalldf[,-c(3,5:7)] %>% 
  left_join(f2)  %>%
  left_join(vif %>% rename('Exogenous Construct' = 'Exogenous.Construct',
                           'Endogenous Construct' = 'Endogenous.Construct')) %>%
  rename('Path Coefficient Bootstrap Mean' = 'Bootstrap Mean',
         '0 in Path Coefficient CI' = '0 in CI',
         'Path Coefficient p' = 'p')
colnames(sumsm)[5] <- paste0("Path Coefficient t(", nrow(model$data), ")")
```
```{r summary table-df print, echo = FALSE}
datatable(sumsm,
          filter = 'top',
          options = list(pageLength = nrow(sumsm)),
          rownames = FALSE,
          colnames = c("f²" = 7),
          caption = 'Structural Model Summary') %>%
  formatRound(c(3,5:8),
              digits = 3) %>%
  formatStyle(colnames(sumsm)[5], backgroundColor = styleInterval(cuts = c(1.65), values = c('#ff9999', '#00'))) %>%
  formatStyle('Path Coefficient p', backgroundColor = styleInterval(cuts = c(0.05), values = c( '#00', '#ff9999'))) %>%
  formatStyle('0 in Path Coefficient CI', backgroundColor = styleEqual(c(1,0), c('#ff9999', '#00'), default = NULL)) %>%
  formatStyle('f²', backgroundColor = styleInterval(cuts = c(0.02), values = c('#ff9999', '#00'))) %>%
  formatStyle('VIF', backgroundColor = styleInterval(cuts = c(3,5), values = c('#00', '#ffe5e5','#ff9999')))
```


# Results summary
The path from Perceived Response Costs to Behavioral Intention is insignificant, and there is no discernible effect.
Perceived Response Costs can be removed from the model as a construct.
The paths from Knowledge to Perceived Response Costs and Perceived Response Efficacy are insignificant and show no effect.
The path from Knowledge to Perceived Response Costs can be removed.
